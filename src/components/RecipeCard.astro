---
import type { CollectionEntry } from 'astro:content';

interface Props {
  recipe: CollectionEntry<'recipes'>;
  class?: string;
  averageRating?: number | null;
  ratingCount?: number;
}

const { recipe, class: className = '', averageRating = null, ratingCount = 0 } = Astro.props;
const { data, slug } = recipe;
const { title, image, prep_time, cook_time, tags } = data;

const totalTime = prep_time + cook_time;
const displayTags = tags.slice(0, 3);
const imagePath = `/images/recipes/${image}`;
const hasRating = averageRating !== null && ratingCount > 0;
---

<div
  class:list={[
    'recipe-card relative group bg-ctp-surface0 rounded-2xl overflow-hidden',
    'border border-ctp-surface1',
    'transition-all duration-200',
    'hover:bg-ctp-surface1 hover:shadow-soft-md hover:scale-[1.01]',
    className,
  ]}
  data-slug={slug}
>
  {/* Favorite Button */}
  <button
    type="button"
    class="favorite-btn absolute top-3 right-3 z-10 p-2 rounded-full bg-ctp-base/70 backdrop-blur-sm border border-ctp-surface1 transition-all hover:bg-ctp-base hover:scale-110"
    aria-label="Add to favorites"
    data-slug={slug}
  >
    <svg
      class="favorite-icon w-5 h-5 transition-colors"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      stroke-width="2"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
      ></path>
    </svg>
  </button>

  <a href={`/recipes/${slug}`} class="block">
    {/* Image container with aspect ratio */}
    <div class="relative aspect-[4/3] overflow-hidden bg-ctp-surface1">
      <img
        src={imagePath}
        alt={title}
        loading="lazy"
        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
      />
    </div>

    {/* Content */}
    <div class="p-4">
      {/* Title */}
      <h3 class="text-lg font-semibold text-ctp-text mb-2 line-clamp-2">
        {title}
      </h3>

      {/* Time and rating row */}
      <div class="flex items-center justify-between mb-3">
        {/* Time badge */}
        <div class="flex items-center gap-1.5 text-sm text-ctp-subtext1">
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span>{totalTime} min</span>
        </div>

        {/* Rating Display */}
        <div
          class="flex items-center gap-1 text-sm"
          title={hasRating ? `${averageRating} out of 5 (${ratingCount} ${ratingCount === 1 ? 'rating' : 'ratings'})` : 'No ratings yet'}
        >
          <svg
            class:list={['w-4 h-4', hasRating ? 'text-ctp-peach' : 'text-ctp-surface2']}
            fill="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
            ></path>
          </svg>
          <span class:list={[hasRating ? 'text-ctp-text' : 'text-ctp-overlay0']}>
            {hasRating ? averageRating?.toFixed(1) : '--'}
          </span>
        </div>
      </div>

      {/* Tags */}
      {
        displayTags.length > 0 && (
          <div class="flex flex-wrap gap-1.5">
            {displayTags.map((tag) => (
              <a
                href={`/tags/${tag}`}
                class="tag-link px-2 py-0.5 text-xs font-medium rounded-full bg-ctp-surface2 text-ctp-subtext1 hover:bg-ctp-mauve/20 hover:text-ctp-mauve transition-colors"
                onclick="event.stopPropagation();"
              >
                {tag}
              </a>
            ))}
            {tags.length > 3 && (
              <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-ctp-surface2 text-ctp-overlay0">
                +{tags.length - 3}
              </span>
            )}
          </div>
        )
      }
    </div>
  </a>
</div>

<style>
  .favorite-btn .favorite-icon {
    @apply text-ctp-overlay0;
  }

  .favorite-btn:hover .favorite-icon {
    @apply text-ctp-red;
  }

  .favorite-btn.is-favorite .favorite-icon {
    @apply fill-ctp-red text-ctp-red;
  }
</style>

<script>
  // Initialize favorites from localStorage
  function initFavorites() {
    const favorites = JSON.parse(
      localStorage.getItem('favorites') || '[]'
    ) as string[];
    document.querySelectorAll('.favorite-btn').forEach((btn) => {
      const slug = (btn as HTMLElement).dataset.slug;
      if (slug && favorites.includes(slug)) {
        btn.classList.add('is-favorite');
        btn.setAttribute('aria-label', 'Remove from favorites');
      }
    });
  }

  // Toggle favorite status
  function toggleFavorite(slug: string, btn: HTMLElement) {
    const favorites = JSON.parse(
      localStorage.getItem('favorites') || '[]'
    ) as string[];
    const index = favorites.indexOf(slug);

    if (index === -1) {
      favorites.push(slug);
      btn.classList.add('is-favorite');
      btn.setAttribute('aria-label', 'Remove from favorites');
    } else {
      favorites.splice(index, 1);
      btn.classList.remove('is-favorite');
      btn.setAttribute('aria-label', 'Add to favorites');
    }

    localStorage.setItem('favorites', JSON.stringify(favorites));
  }

  // Event delegation for favorite buttons
  document.addEventListener('click', (e) => {
    const btn = (e.target as HTMLElement).closest(
      '.favorite-btn'
    ) as HTMLElement;
    if (btn) {
      e.preventDefault();
      e.stopPropagation();
      const slug = btn.dataset.slug;
      if (slug) {
        toggleFavorite(slug, btn);
      }
    }
  });

  // Initialize on page load
  initFavorites();

  // Re-initialize when navigating with View Transitions (if enabled)
  document.addEventListener('astro:page-load', initFavorites);
</script>
